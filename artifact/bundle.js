function t(t){return t.replace(/^[\\"' ]*(.*?)[\\"' ]*$/,"$1")}function e(t){const e=[];let a="",s=!1,r="",n=0,o=0;for(let i=0;i<t.length;i++){const l=t[i];'"'!==l&&"'"!==l||0!==i&&"\\"===t[i-1]||(s?l===r&&(s=!1):(s=!0,r=l)),"["===l&&n++,"]"===l&&n--,"{"===l&&o++,"}"===l&&o--,","!==l||s||0!==n||0!==o?a+=l:(e.push(a.trim()),a="")}return a.trim()&&e.push(a.trim()),e}function a(t){const e=[];let a="",s=!1,r="";for(let n=0;n<t.length;n++){const o=t[n];'"'!==o&&"'"!==o||0!==n&&"\\"===t[n-1]?"."!==o||s?a+=o:(e.push(a),a=""):s?o===r?s=!1:a+=o:(s=!0,r=o)}return a&&e.push(a),e.join(".")}async function s(s,r){var o=!1;await eventEmit(n.VARIABLE_UPDATE_STARTED,r,o);var i=_.cloneDeep(r),l=function(a){const s=[],r=/_\.set\(([\s\S]*?)\);\s*(?:\/\/(.*?))?(?:\n|$|\r)/g;let n;for(;null!==(n=r.exec(a));){const a=n[0],r=n[1],o=n[2]?n[2].trim():"",i=e(r);i.length>=3?s.push({fullMatch:a,path:t(i[0]),oldValue:t(i[1]),newValue:t(i[2]),reason:o}):2===i.length&&s.push({fullMatch:a,path:t(i[0]),oldValue:t(i[1]),newValue:t(i[1]),reason:o})}return s}(s),c=!1;for(const e of l){var{path:d,newValue:u,reason:f}=e;if(d=a(d),_.has(r.stat_data,d)){const e=_.get(r.stat_data,d);if(_.isString(u)&&u.trim().startsWith("[")&&u.trim().endsWith("]"))try{const t=JSON.parse(u);Array.isArray(t)&&t.length>0&&(u=t[0])}catch(t){console.error(`Error parsing JSON array for '${d}': ${t.message}`)}if("number"==typeof e){const t=Number(u),a=e;_.set(r.stat_data,d,t);const s=f?`(${f})`:"",o=`${a}->${t} ${s}`;_.set(i.stat_data,d,o),c=!0,console.info(`Set '${d}' to '${t}' ${s}`),await eventEmit(n.SINGLE_VARIABLE_UPDATED,r.stat_data,d,a,t)}else if(Array.isArray(e)&&2===e.length){const a="number"==typeof e[0]?Number(u):t(u),s=_.cloneDeep(e[0]);e[0]=a,_.set(r.stat_data,d,e);const o=f?`(${f})`:"",l=`${s}->${u} ${o}`;_.set(i.stat_data,d,l),c=!0,console.info(`Set '${d}' to '${a}' ${o}`),await eventEmit(n.SINGLE_VARIABLE_UPDATED,r.stat_data,d,s,a)}else{const a=t(u),s=_.cloneDeep(e);_.set(r.stat_data,d,a);const o=f?`(${f})`:"",l=`${s}->${a} ${o}`;_.set(i.stat_data,d,l),c=!0,console.info(`Set '${d}' to '${a}' ${o}`),await eventEmit(n.SINGLE_VARIABLE_UPDATED,r.stat_data,d,s,a)}}else{const t=`undefined Path: ${d}->${u} (${f})`;console.error(t)}}return r.display_data=i.stat_data,await eventEmit(n.VARIABLE_UPDATE_ENDED,r,o),c||o}async function r(){var t=[];try{await getChatMessages(-2,{role:"assistant",include_swipes:!0})}catch(t){}if(t||(t=[]),t.length<=0){var e=await getChatMessages(0,{include_swipes:!0});if(!(e&&e.length>0))return void console.error("不存在任何一条消息，退出");t=e}var a=t[0],r=a.swipes_data[a.swipe_id],n=(await getLorebookSettings()).selected_global_lorebooks,o=await getCurrentCharPrimaryLorebook();null!==o&&n.push(o),void 0===r&&(r={display_data:{},initialized_lorebooks:[],stat_data:{}}),_.has(r,"initialized_lorebooks")||(r.initialized_lorebooks=[]),r.stat_data||(r.stat_data={});var i=!1;for(const t of n)if(!r.initialized_lorebooks.includes(t)){r.initialized_lorebooks.push(t);var l=await getLorebookEntries(t);for(const t of l)if(t.comment?.toLowerCase().includes("[initvar]"))try{const e=JSON.parse(substitudeMacros(t.content));r.stat_data=_.merge(r.stat_data,e)}catch(t){return console.error(`Failed to parse JSON from lorebook entry: ${t}`),void toastr.error(t.message,"Failed to parse JSON from lorebook entry",{timeOut:5e3})}i=!0}if(!i)return;console.info("Init chat variables."),await insertOrAssignVariables(r);for(var c=0;c<a.swipes.length;c++){var d=_.cloneDeep(r);await s(a.swipes[c],d),await setChatMessage({data:d},a.message_id,{refresh:"none",swipe_id:c})}const u={context_percentage:100,recursive:!0},f=await getLorebookSettings();_.isEqual(_.merge({},f,u),f)&&setLorebookSettings(u)}eventOn(tavern_events.GENERATION_ENDED,(async function(){const t=await getLastMessageId();var e=await getChatMessages(t);if(e.length>0){var a=e[e.length-1];if("assistant"!=a.role)return;var r=!1,n=a.message;const i=await async function(t){for(;!(t<0);){var e=await getChatMessages(t);if(e.length>0){var a=e[0].data;if(_.has(a,"stat_data"))return a}--t}return await getVariables()}(t-1);if(!_.has(i,"stat_data"))return void console.error("cannot found stat_data.");var o=!1;if((o=o||await s(n,i))&&await replaceVariables(i),await setChatMessage({data:i},t,{refresh:"none"}),!n.includes("<CharView")&&!n.includes("<StatusPlaceHolderImpl/>"))if(n.includes("<StatusPlaceHolder/>")){const t="<StatusPlaceHolderImpl/>";n=n.replace("<StatusPlaceHolder/>",t),r=!0}else{n+="\n\n"+"<StatusPlaceHolderImpl/>",r=!0}r&&(console.info("Replace content...."),await setChatMessage({message:n},t,{refresh:"display_and_render_current"}))}})),eventOn(tavern_events.MESSAGE_SENT,r),eventOn(tavern_events.GENERATION_STARTED,r);const n={SINGLE_VARIABLE_UPDATED:"mag_variable_updated",VARIABLE_UPDATE_ENDED:"mag_variable_update_ended",VARIABLE_UPDATE_STARTED:"mag_variable_update_started"};export{n as variable_events};
//# sourceMappingURL=bundle.js.map